FROM linaro/ci-#{ARCH}-tcwg-base-ubuntu:#{DISTRO}

COPY new-user.sh /usr/local/bin/

RUN new-user.sh --user tcwg-buildslave:11827 --group tcwg-infra:9000 \
 && new-user.sh --user tcwg-benchmark:12326 --group tcwg-infra \
 && mkdir -p /home/tcwg-buildslave/workspace

COPY tcwg-buildslave /home/tcwg-buildslave
COPY tcwg-benchmark /home/tcwg-benchmark

RUN chown -R tcwg-buildslave:tcwg-infra /home/tcwg-buildslave/ \
 && chown -R tcwg-benchmark:tcwg-infra /home/tcwg-benchmark/ \
 && chmod 0700 /home/tcwg-buildslave/.ssh/ /home/tcwg-benchmark/.ssh/ \
 && chmod 0600 /home/tcwg-buildslave/.ssh/* /home/tcwg-benchmark/.ssh/*

#if ARCH_amd64 || ARCH_i386
# Install wine.  On amd64 arch we need to enable i386, otherwise wine
# won't meet dependencies (this is the case at least for trusty and xenial).
RUN \
#if ARCH_amd64
 dpkg --add-architecture i386 && \
#endif
 apt-get update \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
 wine \
 && apt-get clean \
 && rm -rf \
 /var/lib/apt/lists/* \
 /tmp/* \
 /var/tmp/*
#endif
